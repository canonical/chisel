project: chisel

path: /chisel

environment:
  OS: ubuntu
  PRO_TOKEN: $(HOST:echo $PRO_TOKEN)

backends:
  # Cannot use LXD backend due to https://github.com/snapcore/spread/issues/154
  # lxd:
  #   systems:
  #     - ubuntu-bionic
  #     - ubuntu-focal
  #     - ubuntu-jammy
  # GitHub actions (runners) don't support nested virtualization (https://github.com/community/community/discussions/8305)
  # qemu:
  #   systems:
  #     - ubuntu-22.04:
  #         username: ubuntu
  #         password: ubuntu
  #     - ubuntu-22.10:
  #         username: ubuntu
  #         password: ubuntu
  adhoc:
    allocate: |
      echo "Allocating $SPREAD_SYSTEM..."
      image=$(echo $SPREAD_SYSTEM | tr '-' ':')
      docker pull $image
      docker run -e usr=$SPREAD_SYSTEM_USERNAME -e pass=$SPREAD_SYSTEM_PASSWORD --name $SPREAD_SYSTEM -d $image sh -c '
        set -x
        apt-get update
        apt-get install -y openssh-server sudo zstd jq
        mkdir /run/sshd
        useradd -rm -d /home/ubuntu -s /bin/bash -g root -G sudo -u 1000 ubuntu
        echo "$usr:$pass" | chpasswd
        echo "$usr ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        /usr/sbin/sshd -D
      '
      ADDRESS `docker inspect $SPREAD_SYSTEM --format '{{.NetworkSettings.Networks.bridge.IPAddress}}'`
    discard:
      docker rm -f $SPREAD_SYSTEM
    systems:
      - ubuntu-24.04:
          username: ubuntu
          password: ubuntu
      - ubuntu-20.04:
          username: ubuntu
          password: ubuntu

prepare: |
  apt-get install -y golang-1.22-go git
  # Do not depend on the version shipped by the distro, use it only to
  # bootstrap.
  /usr/lib/go-1.22/bin/go install golang.org/dl/go1.23.0@latest
  $HOME/go/bin/go1.23.0 download
  ln -s -f $HOME/go/bin/go1.23.0 /usr/local/bin/go

suites:
  tests/end-to-end/:
    summary: Tests common scenarios using the binary
    systems: [ubuntu-24.04]
    prepare: |
      cd /chisel
      go build -buildvcs=false ./cmd/chisel/
      mv chisel /usr/local/bin
    environment:
        RELEASE/focal: 20.04
        RELEASE/jammy: 22.04
        RELEASE/noble: 24.04
  tests/internal/:
    summary: Run internal tests against specific images
