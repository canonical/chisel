summary: Recut relies on manifest to upgrade existing content

variants:
  - noble

environment:
  ROOTFS: rootfs

execute: |
  mkdir -p ${ROOTFS}

  # TODO: remove this env var when final upgrade strategy is in place.
  export CHISEL_RECUT=1
  # First cut generates manifest and installs slice-a.
  chisel cut --release ./chisel-releases/ \
    --root ${ROOTFS} \
    base-files_slice-a base-files_manifest

  test -s ${ROOTFS}/etc/debian_version
  test -f ${ROOTFS}/chisel/manifest.wall

  # Remove a file installed from slice-a.
  rm -f ${ROOTFS}/etc/debian_version

  # Second cut, only requesting slice-b. slice-a should be restored via manifest.
  chisel cut --release ./chisel-releases/ \
    --root ${ROOTFS} \
    base-files_slice-b

  test -s ${ROOTFS}/etc/debian_version
  test -s ${ROOTFS}/etc/issue
  test -f ${ROOTFS}/chisel/manifest.wall
