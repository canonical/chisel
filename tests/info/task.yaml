summary: Chisel can show detailed info about slices

execute: |
  set -e

  apt update && apt install -y wget

  check() {
    pkg="$1"
    slice="$2"

    wget -q "https://raw.githubusercontent.com/canonical/chisel-releases/${OS}-${RELEASE}/slices/${pkg}.yaml" \
      -O "${pkg}.yaml"

    cat <(yq "... comments=\"\" | .essential.[]" "${pkg}.yaml") \
      <(yq "... comments=\"\" | .slices.${slice}.essential.[]" "${pkg}.yaml" ) | \
      sort > expected-essentials
    chisel info --release ${OS}-${RELEASE} "${pkg}_${slice}" | \
      yq ".slices.${slice}.essential.[]" | sort > obtained-essentials
    diff expected-essentials obtained-essentials

    yq "... comments=\"\" | .slices.${slice}.contents" "${pkg}.yaml" | \
      yq 'sort_keys(...)' | \
      yq '(... | select(type == "!!seq")) |= sort' | \
      yq -o yaml -P | \
      sed 's/\ {}$//g' > expected-contents
    chisel info --release ${OS}-${RELEASE} "${pkg}_${slice}" | \
      yq "... comments=\"\" | .slices.${slice}.contents" | \
      yq 'sort_keys(...)' | \
      yq '(... | select(type == "!!seq")) |= sort' | \
      yq -o yaml -P | \
      sed 's/\ {}$//g' > obtained-contents
    diff expected-contents obtained-contents

    diff <(yq "... comments=\"\" | .slices.${slice}.mutate" "${pkg}.yaml") \
      <(chisel info --release ${OS}-${RELEASE} "${pkg}_${slice}" | yq "... comments=\"\" | .slices.${slice}.mutate")
  }

  check base-files base
  check ca-certificates data
  check libc6 libs
  check openssl config
