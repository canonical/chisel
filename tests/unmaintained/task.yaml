summary: Chisel can fetch packages from unmaintained releases

variants:
  - mantic

environment:
  ROOTFS: rootfs

execute: |
  mkdir "${ROOTFS}"

  # TODO: change to the upstream release when it has maintenance set.
  ! OUTPUT=$(chisel cut --release ./release-${RELEASE} --root ${ROOTFS} hello_bins 2>&1)
  echo "$OUTPUT" | grep "this release has reached the \"unmaintained\" maintenance status, see https://documentation.ubuntu.com/chisel/en/latest/reference/chisel-releases/chisel.yaml/#maintenance for details"

  OUTPUT=$(chisel cut --release ./release-${RELEASE} --root ${ROOTFS} --ignore=unmaintained hello_bins 2>&1)
  echo "$OUTPUT" | grep "Warning: This release has reached the \"unmaintained\" maintenance status. See https://documentation.ubuntu.com/chisel/en/latest/reference/chisel-releases/chisel.yaml/#maintenance to be safe"

  test -f ${ROOTFS}/usr/bin/hello
  test -f ${ROOTFS}/usr/share/doc/hello/copyright

  # Remove the maintenance block.
  sed -e "/maintenance:/,+3d" -i ./release-${RELEASE}/chisel.yaml
  ! chisel cut --release ./release-${RELEASE} --root ${ROOTFS} --ignore=unmaintained
  ! chisel cut --release ./release-${RELEASE} --root ${ROOTFS} hello_bins
